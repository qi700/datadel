虚拟化平台下数据存储方式的选择与优化探讨
服务器虚拟化实现了应用和操作系统与硬件的分离,但在存储虚拟化之前还无法实现数据与存储设备硬件的分离,各类应用系统运行的稳定性不再是由服务器硬件的稳定性,而是由存储设备的稳定性决定。对虚拟化平台中存储方式的选择及优化进行了探讨,并分析了各类存储方式在虚拟化平台中应用的特点,针对这些特点给出了一些在虚拟化平台下选择及优化存储系统的方法。引言    近年来IT技术快速发展，虚拟化技术日趋成熟，由于虚拟化能大幅降低数据中心的总体成本、简化服务器的管理、实现服务器的快速部署和提高数据中心的可靠性，越来越多的组织开始部署虚拟化平台杠。数据中心的虚拟化主要包括服务器和存储的虚拟化，目前服务器的虚拟化得到了广泛应用，但存储设备虚拟化因产品价格昂贵且缺少标准化，不同厂家的存储设备无法在一个虚拟化平台下进行整合，所以存储设备虚拟化的进展十分缓慢。虚拟化使服务器硬件资源的利用率从不足20%提升到60%以上，服务器对存储设备的读写速率、整体性能和可靠性等要求也更高。服务器虚拟化带来的最具增值性的功能，如在备用物理主机上快速重新启动出现故障的虚拟机、负载均衡或无中断地跨物理主机迁移虚拟机等，都必须得到存储系统的支持才能实现。为了满足这些服务器虚拟化后对存储设备新的需求，存储设备同样需要进行针对性的调整。    服务器虚拟化对存储性能、可靠性、连接方式等提出诸多新要求，但是多数组织仍然采用向物理服务器提供存储的方式来建设、管理虚拟服务器的存储系统，这使得虚拟机的许多重要优点、功能无法得到充分应用。因此，虚拟化需要针对虚拟基础设施而设计的存储设备，存储设备的选择在整个虚拟机环境建设、运行和管理过程中有着举足轻重的作用。要使部署虚拟化技术的利益最大化，必须对服务器、存储设备甚至网络基础设施采用全盘考虑的部署方式。没有存储设备及网络的支持，就不可能利用虚拟环境的最具增值性的功能，也不可能在不牺牲性能的情况下提高虚拟化整合比例。    目前对存储平台虚拟化的研究较多，但对如何满足服务器虚拟化对存储方式的选择及优化的研究还远远不够，对各种类型的存储如DAS,NAS,SAN和iSCSI在虚拟化环境中的应用特点研究也不够充分。本文在对各类存储在虚拟化环境中应用特点研究的基础上，探讨了如何为虚拟化平台选择及优化存储系统。1 影响虚拟机存储方式选择的因素    在选择虚拟化平台的存储方式时，认真评估虚拟化平台下存储系统的应用环境、需求，以及虚拟化和存储行业的发展趋势是极其重要的。伴随着对存储系统高性能的需求，对存储系统管理的简便性和数据共享J胜等需求也在不断增加，存储系统的选择应该平衡各方面的需求，并且考虑所部署技术的复杂性和成熟度。在选择虚拟化平台的存储方式时，除了对存储设备的常规性能要求以外，还应重点考虑I/0性能、可管理性、兼容性、可扩展性和可靠性等方面的因素。    1.1  I/O性能影响    服务器虚拟化会将多台服务器连接到有限的1台或几台存储设备上，这样做的好处显而易见，但这却会造成存储资源I/O性能瓶颈问题。在传统技术上，I/ 0存储系统就一直是计算机系统中的制约因素，降低了计算机系统甚至是整个IT系统的整体性能，尤其在虚拟化环境下这种矛盾变得更为突出:随着虚拟机和硬件服务器整合比的提高，如果用户缺少对存储系统I/0的规划，将虚拟机任意放在主机上而不去考虑其磁盘的I/ 0使用情况，带来的结果是物理资源的激烈竞争，很快就会遇到I/O资源瓶颈问题。因此建立高效的存储系统是提高整个虚拟机系统处理能力的关键因素之一，在规划虚拟机的存储设施时应重点考虑存储设施的I/ O性能，而不仅仅是存储系统容量的大小。    1.2可管理性    随着虚拟机数量的不断增加，通过传统的方式来管理存储设备变得越来越困难，‘这对虚拟机存储的可管理性提出了更高的要求。虚拟化存储设备在管理上首先要求的就是数据的集中存储，分散的数据不利于对存储的使用和管理，在存储空间的分配、存储资源的划分、数据的备份等方面都会带来麻烦。虚拟机的可扩展性和分配是非常快捷和高效的，用户可以在非常短的时间内完成部署虚拟化主机系统，但如果后端存储系统系统没有良好的支撑能力，虚拟机就无法完成正常部署。随着虚拟机数量的增多，基于单个操作系统的数据备份和维护将变得非常繁琐，但如果存储系统支持，就可以通过执行脱离虚拟机的备份，甚至使用基于存储的快照和克隆功能来快速备份虚拟机的管理功能，这将极大地提高对虚拟机的管理效率。因此虚拟化环境中存储系统需要具备高效的可管理性和简单、快速的部署能力。    1.3兼容性    虚拟化平台可以使用诸如DAS,NAS,SAN和iSCSI等各种物理存储设备上的存储空间，但这些存储方式与虚拟化的兼容程度差异较大。服务器虚拟化技术的应用必然伴随着虚拟机的迁移，这种迁移必须得到存储系统的支持才能实现，例如:实时虚拟机迁移、原始设备映射、虚拟机集群、高可用性和分布式资源调度等虚拟化平台下的重要应用，不同的存储方式对其的支持情况就完全不同，各类存储方式对虚拟化平台的支持情况，将在3. 1中详细表述。虚拟化环境下的存储系统应该与虚拟机具备良好的兼容性，为虚拟化平台提供全面的支撑平台。    1.4可扩展性    在虚拟化环境下，存储需要承载的数据骤增，变化范围很大，在容量增长的同时，性能也要同步提升。虚拟机系统的存储系统应该是能够支撑更多虚拟系统的存储设备，应该具备一定的性能弹性，能满足计划内和计划外的工作负载，当虚拟机的数量增加导致对存储的需求加大时，存储系统应该有能力完成性能的提升。存储体系结构必须提供灵活性和弹性，在不降低虚拟机性能需求的前提下进行性能和容量的扩展。    1.5可靠性    在虚拟化环境下，存储的可靠性和可用性变得尤其重要。一台物理服务器故障，受影响的只是这台服务器上运行的虚拟机和服务，通过虚拟机的飘移技术，可以迅速恢复故障服务器上的服务。虚拟化使得服务器的数量减少，服务器的利用率提高，但服务的风险也高度集中，如果存储设备停机，有可能导致多台物理服务器及这些服务器上的服务停止，而且存储上的故障排除要比服务器上复杂、耗时。因此，单台存储设备的可靠性、存储系统整体的可用性在虚拟化平台下都变得更为重要。
2 各类存储在虚拟化环境下的应用特点    2. 1直连存储    直连存储(Direct Attached Storage,DAS)是一种存储器直接连接到服务器的存储设备。主机内部的磁盘、闪存和直接连接的外部磁盘组都属于DAS的实例。尽管存储网络技术的使用越来越普遍，但DAS仍然是访问和共享本地数据的理想方案，尤其是在服务器数量较少的环境里或一些不需要跨越整个组织来共享信息的应用环境。DAS配置简单，并且部署容易和快速，可以通过基于主机上的工具来进行安装管理。当服务器的数据存储往往依赖于操作系统，同时服务器的处理及吞吐能力也有限，对数据存储的需求也不是十分巨大的情况下，DAS是1种理想的解决方案。    DAS的缺点也非常明显。1个存储设备只有有限的端口，这限制了主机能直接连接的存储设备的数量，有限的DAS带宽也限制了其可用的I/0能力，无法优化资源使用，因为它共享前端端口的能力有限，未被使用的资源不能方便地重新分配，结果导致形成过载和欠载的孤立存储池。虚拟化带来的最具增值性的功能如在备用物理主机上快速重新启动出现故障的虚拟机、负载均衡或无中断地跨物理主机迁移虚拟机等必须得到存储系统的支持才能实现，而这些能力DAS都不具备。    2. 2存储区域网    存储区域网络(Storage Area Network , SAN)是1个高速的，专用的服务器网络和共享存储设备。一般情况下SAN通过光纤通道(Fiber Chanel, FC)网络连接，将分散的存储组成1个单一的存储池，如图1所示。DAS是1种孤立的存储环境，主机拥有存储设备，但这些孤立存储设备上的信息很难管理和共享，为了将这些分散的数据组织起来，SAN应运而生。SAN实现了数据的集中和整合，提供了高效的管理机制和数据保护能力，更有利于组织管理。SAN减少了总的运营开销和失效时问，并且使应用的部署更加快捷。相对于DAS而言，SAN的稳定性、可用性和冗余性都得到了大幅提高，而且对VMware的虚拟化平台ESX各项功能支持也更全面，使虚拟化的优势可以得到更充分的利用。最新的8 GFC提供了1600 M B/s的吞吐率，而目前应用的SCSI最高可用吞吐率也只有320MB/s。因此SAN的性能和数据传输速度也比DAS高。  图1 SAN与DAS存储方式比较    在虚拟机存储应用领域，SAN因为稳定性高、性能强，主要用来存储虚拟机平台上的操作系统和各种对存储性能要求高的重要数据。通过SAN可以为某个虚拟机而不是某台固定的服务器分配存储空间，这些存储空间可以在不同的服务器之间动态地迁移工作负荷。SAN是可以让多台物理服务器共享的存储，更便于虚拟机的迁移和保护。选择存储方式时，如果性能具有最高的优先级，那么使用SAN是最好的方案，但SAN部署及维护成本非常高，不适合在服务器数量较少或对存储设备性能、可靠性要求不高应用环境部署。    2. 3网络连接存储    网络连接存储(Network Attached Storage , NAS)是1种连接到局域网的基于IP的文件共享设备，VAS设备一般情况下是1个专用的、高性能的、高速的、单纯用途的文件服务和存储系统。NAS提供服务器整合的优势，它通过文件级的数据访问和共享，提供存储的整合。NAS是1个优越的存储方案，使得客户可以快速和直接共享文件，而且只需要很小的存储管理开销。    从架构而言，NAS是对存储、管理和提供文件的方式进行优化。管理文件通常比管理逻辑单元号( Logical Unit Number, LUN)更为简单。所以根据定义来看，NAS是1种比SAN更加简单的网络存储。NAS相比SAN可以提供一些更高级的功能，因为存储阵列拥有对文件系统的控制权。在NAS阵列中，诸如快照和克隆这样的技术可以得到更为全面的支持。NAS所使用的网络文件系统(Network File System , NFS)是1种跨平台协议，使得备份、复制或其它任务对虚拟机的访问变得简单。    在虚拟化平台中，NAS性能、稳定性以及和虚拟化平台的兼容性比SAN稍差，但NAS目前已经能够广泛地支持VMware的各种基础于虚拟平台的扩展功能，目前仅不能支持存储实时迁移和虚拟机集群功能。NAS在支持虚拟机应用功能上和SAN的差距越来越小。此外，VMware环境中可以存在NAS和SAN棍合的网络存储方案，用户可以根据应用系统的特点灵活选用，尤其是在基础架构中已经存在某种网络存储方式时，这更加是1个合理的选择方案。
2. 4互联网小型计算机系统接口    互联网小型计算机系统接口(Internet  SmallComputer System Interface , ISCSI)是一种基于IP的协议，它通过IP来建立和管理存储设备、主机和桥接设备之间的连接，ISCSI使用SCSI通过基于IP的网络来进行块级别的数据传输，包括以太网网络和互联网，ISCSI属于IPSAN的1种。传统的SAN环境中，数据是以块I/ 0的形式在光纤通道上进行传输的，而NAS环境中数据以文件I/ 0的形式在IP网络上传输。用户不仅需要SAN的高性能和可扩展性，也希望融合NAS解决方案的高易用性和更低的总成本。支持在IP网络之上的块I/ O操作的IP技术正是定位于客户的这种需求之上。    目前，由于成本相对较低且易于实现，ISCSI已经广泛应用于服务器和存储设备之间的连接，特别是在原来没有部署SAN的环境中。具有低廉、开放、大容量、传输速度高、安全等诸多优点，非常适合在网络上存储和传输大量数据的应用环境。    在虚拟化平台中ISCSI比SAN减少了配置、维护、管理的复杂度。企业现有的网络管理人员就可以完成日常的管理与维护工作。因为ISCSI是基于IP网络的存储系统，所以数据迁移和远程镜像非常容易，只要网络带宽支持，基本没有距离限制，更好地支持异地容灾。与现有网络基础结构融合，支持跨平台数据共享，这些特点正是虚拟化平台所需要的。3 存储系统的选择    在进行存储方式选择时，首先要明确在部署的虚拟化平台中存储的哪些功能是必须的，部署这些存储的虚拟化平台将在服务器虚拟化方面将深人到什么程度，然后，列出虚拟化平台对存储系统的需求、目标和优先级，在I/ 0性能、可管理性、兼容性、可扩展性和可靠性等因数之间找到1个平衡点。在存储方式的选择时应从存储系统的功能、整体系统及I/ O性能等方面进行重点考虑。    3. 1根据存储系统的功能选择    用户在选择虚拟存储方案时应首先考虑所选择的存储方案是否支持用户生产环境中所需要的虚拟化功能，即根据存储方式对虚拟化平台功能支持的能力进行选择，表1比较了不同存储方式对VMware的ESX虚拟平台各种重要功能的支持情况。    表1不同存储方式对ESX虚拟平台支特比较    不同的存储方式都有各自的优点，例如在虚拟化平台中，即使在已经部署了SAN和NAS存储网络的环境中，DAS仍是不可或缺的1种存储方式，它可以做为SAN和NAS的辅助存储，尽管支持将虚拟机的操作系统安装在网络存储设备上，通过boot-from-san的方式来启动硬件服务器，但虚拟软件提供商还是建议将虚拟机操作系统安装在DAS中。在解决虚拟机系统无法启动的故障时，系统存储在DAS里远比解决1个boot-from-san的问题要简单的多。    因此用户需要根据虚拟化平台中存储数据的特点，及各类存储方式的特点进行存储方式的选择。SAN对虚拟化平台的支撑能力最强，在优先考虑可靠性、适应性和灾难恢复速度等因素时应该使用SAN ,但SAN部署成本、管理成本高，所以并不是在所有的虚拟化平台下都适合选用SAN的存储方式。存储虚拟化平台操作系统ESX可以选择存储在DAS上;ESX平台下的操作系统和一些对性能要求特别高的数据可以选择存储SAN上;对存储空间大小及部署灵活性要求高的数据可以存储在ISCSI上。    3. 2根据存储系统的整体性能选择    在虚拟化环境中，管理员通常只关注 CPU和内存的限制，存储性能往往是容易被忽略的一个问题。不同类型的存储提供的性能差异巨大，8 GB光纤通道的SAN和1 GB的ISCSI接口的NAS相比，性能上的差距相当明显，但是常规的应用，ISCSI和NAS的性能水平是可以接受的，尤其是在虚拟化平台部署的初期。除了存储协议上有所不同，硬盘转速和接口也会有不同，比如转速为10 000 r/min和15 000 r/min，接口也有SAS,SATA和固态硬盘的不同。正是因为有如此多的存储种类供选择，用户才可以更好的选择适合自己虚拟化平台的存储设备。将性能较差的虚拟机配备相对性能较差的存储层级，相对核心的虚拟机则配备性能较强的存储层级。用户同样可以选择自动存储层级系统比如像EMC公司的FAST技术，这种技术可以根据主机的实际需求来自动迁移数据并将它们放置在合适的存储设备上。表2比较了虚拟化环境下各种存储方式的性能及应用环境。表2存储方式的性能与应用环境比较    根据性能上需求的不同，用户可以选择将存储设备分成多个层级，不同需求的虚拟机使用不同的存储层级。一个普遍的做法是在存储上创建不同的分区用作不同的用途，比如操作系统、Windows的页面文件、应用和数据。较快的存储层级可以被用作数据相对较高的I/ 0请求，剩下较慢的存储层级可以用于其他。
3. 3根据存储系统的I/ O性能选择    物理存储环境的许多部署存储的方法也适用于虚拟存储环境，在配置虚拟平台的存储架构时，应以实现环境所需要的I/ O性能来配置存储资源并调整其规模，然后再针对存储容量进行配置和调整。如果1台物理主机上有太多高I/0的虚拟机，可能会对这台主机上的存储控制器造成很大的压力，当太多的高I/0的虚拟机同时访问1个存储系统或者LUN，也会造成性能上的瓶颈。    建立统一的网络存储平台具有显著的优势，可以提高利用率并简化管理，但也可能导致争用。包括提高存储资源利用率和简化管理，但是有时工作负载过高会影响性能。可以对虚拟磁盘使用VMware的虚拟机文件系统(Virtual Machine File System , VMFS)卷，只是应考虑将高I/ 0负载的虚拟磁盘放在专用VMFS卷或原设备映射(Raw Device Mapping, RDM)上，以减少争用的发生。将多个工作负载整合到1组具有共享存储池的ESX服务器上时，不要超出该存储资源的总体吞吐容量。    在进行虚拟化平台下的存储类型选择时，应汇集环境中所有应用程序的I/ 0需求，并根据需要调整其规模，在计算I/ 0大小时，应该使用测量的工作负载汇总值，而不能使用估算值来确定要使用什么协议、冗余保护和阵列功能。存储系统的I/ O能力和其性能基本成正比，因此在判断1种存储方式的I/ 0能力时，可以参考表2中的参数。4 结语    在虚拟化平台中，各种存储方式本身并无优劣之分，关键看应用环境对存储设备的需求是什么，各种存储方式在虚拟化平台下都有适用的场景。良好的虚拟化服务器环境需要服务器、存储和网络协同工作才能实现，虽然服务器、存储和网络变得越来越专业，但是为了建立平衡的虚拟服务器存储策略，应从服务器、存储和网络3个角度分别进行评估，同时还应充分考虑其他两种设备的需求，才能使虚拟服务器的存储计划高效地满足对IT设施增长、成本控制和性能等方面的需求。