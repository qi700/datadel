省级数据中心自建系统数据集中存储备份平台建设
为了充分发挥数据集中存储管理与备份的优势,人民银行广州分行省级数据中心启动省级数据中心自建系统数据集中存储备份平台(以下简称"自建系统数据集中存储备份平台")建设,逐步将自建系统的数据迁移到省级数据中心存储备份平台中,依托集中存储系统与IBM磁带库,进一步提高数据存储与备份管理的规范性、科学性.    为了充分发挥数据集中存储管理与备份的优势，人民银行广州分行省级数据中心启动省级数据中心自建系统数据集中存储备份平台(以下简称“自建系统数据集中存储备份平台”)建设，逐步将自建系统的数据迁移到省级数据中心存储备份平台中，依托集中存储系统与IBM磁带库，进一步提高数据存储与备份管理的规范性、科学性。一、自建系统数据集中存储备份平台建设    (一)自建系统数据集中存储备份平台建设目标    自建系统数据集中存储备份平台的建设目标是根据技术环境特点，将具备迁移条件的分行自建系统数据迁移到数据中心A区集中存储设备；通过A区备份服务器实施相应的备份策略管理，将迁移后的生产数据备份到磁带库中；初步建立省级数据中心存储与备份管理技术规范，满足省级数据中心现有系统及未来新建系统数据存储备份需求。    (二)自建系统数据集中存储备份平台建设的背景    1．省级数据中心集中存储备份平台状况    省级数据中心集中存储系统分为省级数据中心新上线系统区和账户、财务系统区2个部分。本次实施针对省级数据中心新上线系统区，该区设备配置如图1所示。    (1)联想HDS AMS2500磁盘阵列    联想HDS AMS2500磁盘阵列共配置38块300 GB磁盘(10T配置)，其中1块磁盘用于热备，不存储数据。按照6：4比例分配，总行统一推广系统使用该磁盘阵列上的22块硬盘，剩余15块硬盘由省行自行使用。磁盘阵列前端8个端口，分别属于2个控制器，每控制器的第1至3个端口为总行统一推广系统使用，第4个端口供省行使用。规划如图2所示。  图1省级数据中心新上线系统区配置  图2联想HDS AMS2S00磁盘阵列的规划图    (2)IBM TS3500磁带库    TS3500磁带库配置了6个驱动器和40T磁带，其中第1至4个驱动器和30 T磁带供总行统一推广的系统使用，部署省级数据中心一期的数据备份。剩余2个驱动器和10T磁带供省行自行使用。    (3)博科32口光纤交换机    省级数据中心新上线系统区配备了博科32口光纤交换机。    2.自建系统数据集中存储平台试点系统状况    本次集中存储备份平台实施选择省级数据中心自建系统执法检查系统(LIAS)及工资套改系统((SCMS)进行系统迁移。LIAS系统和SCMS系统应用服务器和数据库服务器均为X3650 PC Server，数据库均为DB2数据库，数据存储在PC Server的自带硬盘。目前数据库备份通过每天晚上执行在线备份脚本完成，并复制到另一台PC实现异机备份。 (三)存储区域规划与数据库应用整合规划    自建系统数据集中存储备份平台建设的核心内容是存储区域规划与数据库应用整合规划。我们使用联想HDS AMS2500磁盘阵列供省行自行使用的15块硬盘中的4块组成Raid 5的Raid Group，作为迁移后自建系统数据库数据的存储区域。当有新的自建应用系统需要分配空间时，在该Raid Group的862 G内未分配的空间予以分配，且按照6:3:1的比例划分为LUN，在LUN上创建对应的h，分别分配给数据、归档日志、活动日志使用。至于分配空间大小，则考虑自建应用系统的实际存储需求。    迁移后的数据库应用将整合部署在专用的省级数据中心自建系统数据库服务器中，该数据库服务器与省级数据中心存储平台连接。各应用数据库将在服务器的新建h中建立。新建h的命名如下:自建应用系统简称_data_4k，自建应用系统简称_db_arclog，自建应用系统简称_db_log。对应的mount point(如下:/gddc/自建应用系统简称_dbdata, /gddc/自建应用系统简称_db_arclog,/gddc/自建应用系统简称_db_logo LIAS系统和SCMS系统初期均分配SG空间，具体清况如图3所示。表1描述了相应lv及Cmount point信息。    (四)自建系统数据集中存储备份平台建设实施内容在自建系统数据集中存储    1.实现自建系统服务器与集中存储系统及磁带库SAN组网配置    广州分行省级数据中心自建系统服务器原本没有连接省级数据中心A区集中存储，需要拉一条光纤连接省级数据中心自建系统服务器和省级数据中心A区集中存储，并在光纤交换机配置zone，使得省级数据中心自建系统服务器可以识别省级数据中心A区集中存储以及磁带库。    图3 LIAS系统和SCMS系统的初期分配    表1 Lv和Mount Point的信息    2.自建系统数据迁移的准备    在存储系统中建立分行数据保存区，并在与之相连的省级数据中心自建系统服务器中创建对应逻辑卷，为自建系统数据迁移做好准备。自建系统迁移需要将自建系统的数据存放在省级数据中心A区集中存储上，为此需要按照总行存储划分规范，在集中存储分配给分行自行使用的磁盘组中，建立划分相应的LUN存放自建系统数据，并在省级数据中心自建系统服务器上创建对应的逻辑卷组，为自建系统数据迁移做好准备。    3.迁移自建系统执法检查系统、工资套改系统的数据    在省级数据中心自建系统服务器上安装数据库管理系统DB2，并创建相应实例db2admin，通过db2move操作将执法检查系统、工资套改系统的数据从原有服务器迁移至与总行下发存储连接的服务器中，实现自建系统数据向总行省级集中存储体系的迁移。    4.备份执法检查系统、工资套改系统数据，并进行备份可用性检查    在省级数据中心自建系统服务器安装netbackup软件并配置为media server，以LAN-free模式实现对统一存储中自建系统数据的备份。利用netbackup管理客户端为执法检查系统、工资套改系统创建相互独立的逻辑磁带池，并创建备份策略，每日在线备份相关系统业务以及数据库日志。完成自建系统生产服务器数据磁带库备份实施后，在备份服务器中安装netbackup客户端，将备份数据在备份服务器中成功恢复，实现异机数据恢复，恢复来验证备份的有效性、可用性。二、自建系统数据集中存储备份平台建设经验    (一)自主探索与厂商远程技术支持服务相结合保证工程顺利开展    本次项目在实际过程中遇到了不少的困难，其中既有netbackup无法备份的问题，也有netbackup无法进行数据库恢复的问题，通过自主思考探索，及时总结自主实施过程中存在的问题，并积极向厂商寻求电话远程支持，起到事半功倍的效果。    (二)安装netbackup服务器的经验    在cluster下安装netbackup服务器时，如果使用服务地址，则主机名需要填写/etc／hosts文件里配置的主机名，不能填写执行hostname命令返回的主机名。    (三)Windows数据库迁移到aix数据库的经验    一是此次数据库迁移主要是在Windows执行db2look命令导出数据库定义脚本，在Windows执行db2move命令"导出数据，然后在aix创建数据库后，执行数据库定义脚本，然后用db2move命令导入数据。    二是数据库定义脚本包含外键的定义时，需要将数据库定义脚本拆分为两部分，将外键定义的脚本放到执行db2move命令导人数据之后执行。    三是数据库定义脚本包含identity字段的表定义时，建表时应该去除identity,属性，在执行db2move命令导入数据之后，再恢复identity属性，并将identity起始值设为当前该字段最大值+1。    (四)执行db2恢复的经验    一是执行数据库恢复的时候可能遇到代码页问题，可能需要在GBK代码页和IS08859—1代码页之间进行转换。当执行db2 RESTORE DATABASE processLOAD／usr／openv／netbackup／bin／nbdb2．s164命令时提示SQLl205N The code page“1386”and/or territory code“1”that has been specified is not valid，则执行db2setDB2CODEPAGE=819；db2 terminate命令。    二是异机恢复时备机主机和恢复主机间通信需要得到master server的支持。具体是异机恢复前需要在master server执行touch／usr／openv／netbackup／db／ahnames／No．Restrictions命令。    三是异机恢复时恢复主机需要备份主机备份时用到的参数信息，包括备份主机名，备份策略，备份时间安排等信息。具体是异机恢复：需要到恢复主机／usr／openv/netbackup/bin下执行．／db2_config，填写数据库用户home目录，如db2admin用户为／home／db2admin，到home目录下执,行chmod 777 db2．conf，参考增加如下信息：    DATABASE process--数据库名    OBJECTTYPE DATA BASE    POLICY SelfBuild_DB_DB2ADMIN_1D_备份策略    SCHEDULE SelfBuild_DB_DB2ADMIN_1D_Defaul--备份SCHEDULE    CLIENT_NAME db_SVF_备份主机名    ENDOPER    四是执行前滚操作时，需要将备份主机的对应日志文件复制到恢复主机的日志目录。具体是执行db2rollforward db process to end of logs and stop命令时，提示SQL4970N LOG日志(如S0000038．LOG)挂起报错时，需在备份主机日志目录或归档日志目录查找相应的报错文件S0000038．LOG，替换当前数据库日志目录的S0000038．LOG文件。当前数据库日志目录通过db2 getdb cfg for process得到。    五是连接数据库时候可能遇到代码页问题，可能需要在GBK代码页和IS08859一1代码页之间进行转换。执行db2 connect to process命令时，提示SQL0332N CODEPAGE错误，则执行db2setDB2CODEPAGE=1386，db2 terminate命令。    (五)要遵守总行对于省级数据中心设备的使用要求    本次项目中涉及到省级数据中心OA区存储、光纤交换机、磁带机，总行关于省级数据中心A区存储哪些盘、光纤交换机哪几个口、磁带机哪些端口归省级数据中心自建系统使用有明确的说明，在项目实施过程中必须遵守这些规范。    (六)要有良好的规划    自建系统数据集中存储备份平台建设是一个长期的过程，自建系统需要逐步迁移到该平台上。众多的系统放到该平台上，对于存储划分，vg，lv，fs的创建需要遵循—定的规范，避免随意性。