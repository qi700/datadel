IPTV LAN接入网的网络解决方案技术白皮书
前言
IPTV即交互式网络电视，是一种利用宽带有线电视网，集互联网、多媒体、通讯等多种技术于一体，向家庭用户提供包括数字电视在内的多种交互式服务的崭新技术。它能够很好地适应当今网络飞速发展的趋势，充分有效地利用网络资源。
IPTV包含了BTV、VOD、nVOD等业务内容，有效开展IPTV业务必须有接入承载网、终端、内容网络以及业务软件系统等各组件的支持。仅接入承载网就包含了DSL接入、LAN接入、FTTx等多种模式，本文将重点描述LAN接入网承载IPTV业务的相关技术。
方案简介
在本方案中，根据IPTV业务特性，对VOD、接入认证等这部分通常采用单播方式来处理，对于BTV、nVOD这样的业务则采用组播方式来处理。
针对上网业务精细化管理的需求，对上网用户采用PUPV的VLAN划分方式，而对于IPTV用户，可以根据具体情况，采用PUPV(一用户一VLAN)或PSPV（一业务一VLAN）方式来进行VLAN划分。对于VOD和认证等基于单播数据流的业务，数据转发比较简单，这里不再赘述。IPTV接入网的难点在于BTV业务组播流的处理，结合IPTV在国内尚处于初期发展阶段，现网中设备大都无法直接支持IPTV业务的现状，提出了集中组播复制和边缘组播复制两种解决方案。在IPTV发展初期，用户量较少时，采用集中复制。而在业务规模开展时，采用边缘复制。这样将组播复制的压力分散在楼道交换机上，可以满足大量IPTV用户接入的要求。
方案支持PPPOE和DHCP+认证方式。通过VLAN隔离或端口隔离来避免用户间的影响。同时通过灵活QINQ来解决精确定位用户和VLAN资源问题。另外，利用BRAS和家庭网关对用户的流量和优先级进行设定，可以有效的控制接入网中的流量，配合QOS的队列调度机制保证IPTV业务的视频质量。
方案中关注如下问题
业务分离
通过VLAN来区分不同业务
接入认证问题
采用PPPOE认证或DHCP+认证
组播复制
集中复制
边缘复制
QOS和安全
队列调度
DHCP SNOOPING OPT82
用户隔离
频道快速切换
接入交换机未知组播丢弃
技术特色
业务分离
用户业务主要为HSI（上网业务）、IPTV业务和VOIP业务，每种业务对网络的要求各不相同，为了便于QOS和安全策略的部署，因此我们必须将业务进行区分。最简单的办法就是通过不同VLAN来标记不同的业务。
考虑到业务特性，上网业务通常需要对用户进行精细化管理，而对IPTV业务通常采用较粗犷的管理模式，因此我们建议通过如下方式来做VLAN规划：对上网业务，采用PUPV（每用户一VLAN），对于IPTV/VOIP业务，采用PSPV（每业务一VLAN），即同一园区内的IPTV用户采用同一VLAN，不同园区的IPTV/VOIP用户采用不同的业务VLAN，在局端，通过灵活QINQ对上网业务的VLAN打外层标签，对于IPTV业务的VLAN不打外层标签。
如上图所示，VLAN21和VLAN22为上网业务，在局端打上外层标签100透传到BRAS，而VLAN3和VLAN4分别为IPTV和VOIP的业务VLAN，VLAN5为组播VLAN（为了节约带宽而专门承载组播业务的VLAN，其对IPTV用户不可见），对于VLAN3/4/5在局端不作处理，直接透传到BRAS或SR上。
不同业务的VLAN具体划分是通过家庭网关来实现的。
需要强调的是，若楼道交换机比较老仅支持VLAN划分但无法支持如IGMP SNOOPIGN、边缘复制等组播特性时，则不能采用上述的将IPTV用户都划分到一个VLAN内（因为组播流将会在VLAN内广播），而是需要将IPTV用户也划分到不同VLAN内（即PUPV方式），此时需要通过园区交换机进行集中复制才能开展IPTV业务，后面会详细介绍这一点。
接入认证
本方案中，上网业务采用PPPOE的认证方式，IPTV业务可以采用PPPOE或DHCP+认证。PPPOE认证方式应用已经很广泛了，在此不再赘述。
DHCP+认证方式是利用DHCP定义的一些OPTION字段来实现的，如通过OPTION60来识别终端类型，通过OPTION82来识别用户位置（实际上就是标记用户）。
图1 DHCP+认证
当网络设备收到STB的DHCP请求报文时，需要在报文后添加OPTION82字段，此时有两种模式进行DHCP+认证，一种是直接把DHCP报文送给DHCP服务器，由DHCP服务器根据OPT82字段来判断该用户是否为合法用户，从而决定是否为其分配IP地址。另一种是DHCP报文先送到BRAS，由BRAS将OPT82字段放到RADIUS的一个子域里，通过RADIUS服务器来进行用户合法性认证，若用户合法，再由DHCP服务器分配IP地址。
组播复制
根据楼道交换机支持的能力，组播复制方式可以采用边缘复制或集中复制。
若楼道交换机比较早时，则不能采用PSPV的VLAN划分方式，而是需要将IPTV用户分到不同VLAN内，此时采用集中组播复制方式。否则可以采用组播边缘复制。
通常在组播点播时，若用户处在不同的VLAN内，则每个VLAN都会有一个组播流，即使用户点播的是同一个频道，链路上也会有多份相同的组播流，这样就浪费了大量的带宽。因此我们引入组播VLAN这个概念，目的就是使用户共用一个走组播业务的VLAN，组播流只在这个VLAN内传输，直到面向最终用户时才进行复制，从而达到节省带宽的目的。不管是集中复制还是边缘复制，都会有一个走组播业务的VLAN，只不过集中复制时这个组播VLAN在园区交换机（集中复制点）上，而边缘复制则在楼道交换机（边缘复制点）上。
边缘复制特性：
边缘复制是在末端L2交换机上实现的特性，其作用有两个：1 将交换机下用户VLAN内的IGMP报文转到组播VLAN内上行；2 将下行组播VLAN内的组播流面向用户端口复制，此时面向用户端口出去的组播报文是不带VLAN TAG的。
在边缘复制中，支持对上行IGMP加入报文抑制和最后用户离开机制，当交换机收到多个对同一个组的加入报文时，将在组播VLAN内只向上透传一份，同样，当有用户离开某个组播组时，只有这个组的最后一个用户的IGMP离开报文才会在组播VLAN内向上透传。从而大大减轻了了上层设备对IGMP报文的处理。
集中复制特性：
集中复制特性是在支持L3特性的交换机上实现的特性。上行IGMP加入报文处理基本上同边缘复制特性。但下行组播数据流时，是根据组播转发表项来将走组播业务的VLAN内的组播数据流复制到用户VLAN中，从而在下行端口的组播数据流是带有用户VLAN ID的，这也是和边缘复制特性的主要不同之处。同样集中复制特性也支持IGMP加入报文抑制和最后用户离开机制。
集中复制特性通常是在园区交换机上实现，由于需要面向用户进行跨VLAN的组播复制，因此对设备性能要求较高，同时这样的机制相比边缘复制而言，会占用较多的园区和楼道之间的带宽，因此建议只在IPTV业务开展初期，用户量较小且楼道交换机功能较弱时采用。若IPTV业务规模发展，用户量较大，则采用边缘复制更为适合。
QOS
方案中通过家庭网关设备在业务终端接入时就分配vlan和优先级标志，在网络中采用的是diffserv模型，针对不同的业务定义不同的COS值，L2交换机上采用SP队列调度，保证端口拥塞时高优先级业务优先传输。
安全
IPTV承载网的安全性包括业务本身的安全（主要只防止非授权访问）和承载网自身的安全。
对于防止非授权用户的访问，可以通过在组播复制点上配置IGMP权限控制，丢弃非授权用户发出的IGMP加入报文，从而达到防止非法用户收看BTV频道的目的。
对于承载网自身的安全，主要依赖于用户隔离（通过VLAN隔离或端口隔离来实现）方式，这样避免了用户间的互相干扰，同时也避免了非法服务器接入等安全隐患。另外可以通过DHCP SNOOPING OPT82来防范DHCP请求攻击造成的DHCP地址池枯竭问题，这是因为支持DHCP OPT82的DHCP服务器可以根据OPT82制定地址分配策略，保证对带有相同OPT82信息的DHCP请求只分配一个IP地址。
频道快速切换
正常情况下，IGMP-Snooping在接收到IGMP Leave报文时不会直接将端口从组播组中删除，而是发送特定组查询报文，如果等待一段时间后没有得到响应，才将该端口从组播组中删除。这样当用户切换频道时，就会出现在一个时段内，有多路组播流流向用户端口，占用带宽，甚至可能影响STB的收视效果。为了解决这个问题，在面向用户组播复制点上要支持Igmp fastleave功能，使交换机收到Leave报文后，直接删除对应的组播转发表项。使得STB不会同时收到多份组播流。Igmp fastleave功能通常在组播复制点等能唯一标识用户的设备上实现。
接入交换机未知组播丢弃
边缘复制下，接入交换机使能了igmp fastleave功能时，会出现接入交换机删除了组播转发表项但上面的组播流仍然在短时间内会流到接入交换机上，这些组播流对接入交换机而言会当作未知组播处理，在同VLAN广播。影响STB的收视效果，若多个用户在同VLAN时还会互相影响。因此需要在接入交换机上使能未知组播丢弃，使这类组播流进入接入交换机后直接丢弃，不作为广播处理。
总结
IPTV LAN接入解决方案采用多样化的部署方式，在业务发展初期集中复制可以帮助运营商迅速开展IPTV业务且有效的保护现网接入设备的投资，而在业务规模发展时可以平滑过渡到边缘复制方案，满足大量接入IPTV用户的需求。利用家庭网关实现业务分离，针对业务实现端到端的QOS，保证了IPTV业务的需求。快速切换频道、未知组播丢弃等技术可以带给用户良好的业务感受。