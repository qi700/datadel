数据备份从虚拟化入手
宜兴人民医院：数据备份从虚拟化入手
宜兴市人民医院于1994年挂牌“二级甲等”医院。2008年医院接收门急诊病人91万人次，收治住院3.5万人次。为了全力打造“数字化医院”，宜兴人民医院近几年累计投入资金2000余万元，不管是在IT架构中实施虚拟化解决方案，还是在数据备份方案中采用重复数据删除技术，宜兴人民医院的信息化都走在了同行的前面，也因此提升了医院的现代化管理水平。
医院的数据中心承载着全院信息系统平台的应用，约有20台PC服务器;底层平台由6台光纤交换机5套EMC存储子系统构建而成。HIS、EHR、PACS等关键应用构建为服务器集群，次要应用单机运行。轻负载应用(如基础架构服务，办公系统)等系统已经整合到VMware ESX Server虚拟服务器。医院约700余台微机组成网络应用，功能覆盖门诊、住院病房、药房等职能部门，HIS、LIS、PACS、OA、电子图书馆、电子病历、远程医疗等系统运转得卓有成效。
“我们非常满意EMC存储系统的可靠性,以及VMware虚拟机在平滑迁移、节约能耗、高可用性、管理简单、可扩展性五大方面的优异表现。在此基础上，我们的本地异机备份方案采用了Avamar虚拟化版本，它在源端重复数据删除及增量备份方面的特点非常适用于医院的业务应用。而在即将建成的异地灾备中心，我们仍然会重点考虑EMC及VMware的解决方案。”―――江苏省宜兴市人民医院信息科科长钱隼南
尽管各个业务系统都运行稳定，但医院对于数据备份的管理却是痛点。一直以来，关键业务数据只是采用B2D作为备份文件进行简单备份，并且每个系统分散备份，备份副本少，备份管理效率低。例如，医院里病人每天的文档都会发生改动，一份病历改了一个字节就生成一个新的文件，假如每天改1000个病历，每个文件都要重新保存，数据量非常大。所以医院只是将最新的文件进行全备，无法保留以前的历史。这样也就意味着不能查询病人以前修改更新过的历史信息。
为了解决上述挑战，医院决定建立本地异机备份方案，对新方案提出“未更改的数据无需备份”，“只备份增量数据”，以及“恢复时只需一次操作即可”等具体要求。此外，还决定在2009年底建立异地容灾中心，要求在不影响现有架构的情况下设计集中备份的解决方案。
五大优势，备份从虚拟化说起
为了避免物理服务器在故障、容量、升级等方面的挑战，宜兴人民医院实施了VMware虚拟化解决方案，该方案目前在国内医疗行业的应用还为数不多。当时，宜兴人民医院一些老的服务器硬件需要升级，所以就做了一些从物理机迁移到虚拟机的工作，通过在虚拟机里运行应用，测试了一段时间发现各方面的效果都比较理想。结合成功的测试及参考其它成功案例，宜兴人民医院最终将OA、WEB、FTP、AD、VPN、防病毒、网管 等系统都迁到VMware虚拟机上运行。
目前宜兴人民医院虚拟架构有三台主机，每台主机上约有十台的虚拟机。对VMware虚拟机的运行体会，江苏省宜兴市人民医院信息科科长钱隼南如是表示：“VMware虚拟机在平滑迁移、节约能耗、高可用性、管理简单、可扩展性五大方面有着优异的表现，对此我们非常满意。”他分别就每个方面的细节进行了介绍。
l VMware虚拟机能够在物理机与虚拟机之间平滑地过渡。比如像OA、WEB这样的一些前端应用，从客户端来讲在物理机和虚拟机上的应用效果都非常稳定。升级的时候，VMware本身也有相应的工具能够实现平滑的迁移。
l 降低设备成本和能耗成本。一方面可以节省服务器空间，随着应用越来越多，不需要随之大量采购硬件设备。另一方面是节约能源，服务器设备本身可以减少耗电，另外硬件设备减少，UPS损耗和散热空调也会随之省电。
l VMware本身的就是一个高可用性的基础架构。当我们将一些应用放在虚拟平台上的话，它也就具有了高可用的特性。在这样的技术平台下面，我们既可以很好地做故障切换，也可以很好地均衡资源，这是VMware虚拟机的优势所在。
l 管理简捷。平台上有一个虚拟架构管理工具，通过这个工具可以一目了然地看所有的虚拟机的状态，可以对资源进行有效的监控和调配。如果是物理机的话，就需要一台台连上去，甚至需要第三方的管理软件来监控，这样就增加了复杂性和采购成本。
l 灵活性及可扩展性。当医院需要增加服务器或主机时都很简单。只需要把它加到机群，配置好即可，那些虚拟机就可以自动地利用这个主机的资源了。增加虚拟机同样非常简捷，只需要复制一份相同配置的机器并做简单配置就行了，加速了部署时间。
只备4G数据，可查询每个文档变化
针对宜兴人民医院已经采用VMware虚拟机的实际情况出来，备份方案采用Avamar虚拟化版本是最好的选择。如果不用这种方案，对医院的整个IT管理架构的管理，可用性，及灵活性方面都会相差很多。
EMC Avamar Virtual Edition (AVE)是一种完全虚拟化的备份和恢复解决方案，被称作Avamar重复数据删除的虚拟化版本，通过Avamar 在源位置执行全局重复数据删除的技术与 VMware 虚拟基础架构的高效性结合起来。它可以加速并简化虚拟机备份，还可以消除对专用备份服务器基础架构的需要。在一般的客户环境下，它可将传统的备份负载从每周高达 200% 减少到2%，备份速度最多可提高 90%。
钱隼南科长对此表示：“我们考虑用Avamar，主要是看中它在重复数据删除方面的特性，Avamar目前主要在应用于我们的数据库和文件系统，几乎包括了所有系统约有400G左右的数据，只有PACS的部分数据没在其中，因为 PACS数据有其自己的特性，病人检查的影像都是不一样的，重复数据删除率很小。我们的备份策略是一个月做一次全备，每天做差异备份，然后定时做日志。这意味着我们可以把一个月的数据全部保存下来，包括一个全备、30个差异备份、每天的日志备份。这在之前是无法实现的，因为这些数据全部备份到磁带上面的话，占用的空间会非常巨大。”
宜兴市人民医院本地异机备份网络
宜兴人民医院在首次备份时能够压缩掉二分之一左右的数据，第二次备份就只是一些修改过的部分，比如电子病例系统。宜兴人民医院每天的增量数据大概只有4G，比原来全备份缩小了100倍。虽然备份数据非常少，但却可以轻松查询到每个更改过的文档。钱隼南科长表示：“当我们决定实施备份方案时，重复数据删除是我们首先考虑的一个方向。因为一份病历往往就是改几个字，这样EMC Avamar虚拟化版本的重复数据删除特性就将非常有效。”
此外，从整个虚拟架构来看，Avamar虚拟版正好匹配。如果是物理版本的话，等同于一个服务器，为了保证高可用性，可能还需要买两套互做支持，以防止硬件故障。而作为软件，Avamar虚拟化版本在可靠性、可管理方面都比在物理机上占优势，备份客户端免费，不限备份客户端数目和类型，可以随时追加备份却不用追加投资。如果采用其它的备份方案，宜兴人民医院至少还要采购一台服务器和一个磁盘阵列，采购成本方面也至少会高出许多。整合、虚拟化、灾备，一个都不少
宜兴人民医院目前所有的数据都保存在EMC五套存储系统中。CLARiiON CX200是宜兴人民医院在2003年初采购的EMC首个存储系统。 CLARiiON CX4 -480是宜兴人民医院最新采购的EMC存储系统，当时的主要需求是通过中高端存储系统实现关键业务的存储整合。在此之前，宜兴人民医院使用的是两台EMC CLARiiON CX500 存储系统分别存放PACS和HIS系统的数据。由于HIS及电子病例系统对IO性能和响应时间要求较高，而PACS则对容量要求更高一些，因此通过CLARiiON CX4 -480的整合存储，可以实现两大核心应用系统互相之间的合理配置，之后做异地容灾备份时会比较容易配置。
在宜兴人民医院整个信息基础架构中，EMC的解决方案包括五台存储系统，VMware虚拟机，以及备份方案中的Avamar虚拟化版本。谈及这些解决方案的使用体会，钱隼南科长对此表示：“首先，我们医院对高可用性的级别要求较高，停机时间非常少，要求系统的可靠性要达到五个9的要求。五个9意味着每年故障停机五分钟左右，但事实上运行这么多年下来每年的时间都不会达到五分钟，所以EMC系统的可靠性非常好。其次，EMC解决方案在性能上也能很好地满足我们的要求，我们医院约有两三千人的门诊量，在院病人一千多人，在系统多业务复杂的压力下，一线应用从来没有出现过系统缓慢的情况。再次是EMC解决方案之间的兼容性很好，我们在安装和调试的时候没有出现过兼容性的问题。像我们在CX500和CX4之间做数据迁移和复制的话，兼容性都非常好，Avamar虚拟化版本在VMware上的应用同样如此。”
2009年底或明年年初，宜兴人民医院将建成新机房，并将新机房做异地容备中心，到时医院会把所有数据和应用都复制到新容灾中心，以进行更好的保护和利用。“我们会在新机房放一套存储系统，把原有存储上的东西复制过去。并且会在新机房放几个虚拟主机，以防原有虚拟机出现问题时可以切换过去。存储系统和虚拟主机的采购依然会重点考虑EMC和VMware。”钱隼南科长最后还特别强调表示：“虚拟化以后有一个很大的好处就是做起容灾就简单多了。